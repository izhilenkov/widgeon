<!DOCTYPE html>
<html>
<head>
<title>Order (Widgeon Dummy Testapp)</title>
<!--<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>-->
<script src="jquery.min.js"></script>
<style>
    body {font-family: Verdana, sans-serif; font-size:0.8em;}
    header,nav, section,article,footer
    {border:1px solid grey; margin:5px; padding:8px;}
    nav ul {margin:0; padding:0;}
    nav ul li {display:inline; margin:5px;}
</style>

<!--
This simple web application is written in order to test abilities of Widgeon gem.
Its design is by intention awkward in order to test the worst case.
-->

<script>
$(document).ready(function(){

    function sleep(milliseconds) {
        var start = new Date().getTime();
        for (var i = 0; i < 1e7; i++) {
            if ((new Date().getTime() - start) > milliseconds){
                break;
            }
        }
    }

    function imitate_loading(){
        sleep(500);
    };

    function show(e){
        imitate_loading();
        e.prop('hidden', false);
        return e;
    };

    function hide(e){
        e.prop('hidden', true);
        return e;
    };

    $('#add_item').click(function(){
        var new_item_number = $('[id^="item"]').size() + 1;
        var new_item = $('#template_item').clone()
            .attr('id','item_' + new_item_number);

        new_item.find('#show_advanced_options').click(function(){
            imitate_loading();
            $(this).next().prop('hidden',
                                !$(this).prop('checked'));
        });

        new_item.find('#show_advanced_options_selector').click(function(){
            imitate_loading();
            $(this).next().prop('hidden',
                                !$(this).prop('checked'));
        });

        var advanced_options_selector = new_item.find('#advanced_options_selector');
        new_item.find('#add_options_filter').click(function(){
            var new_filter_number =
                advanced_options_selector.find('[id^="options_filter"]').size() + 1;
            var new_options_filter = $('#template_options_filter').clone()
                .attr('id', 'options_filter_' + new_item_number + '_' + new_filter_number);

            new_options_filter.find('#options_scope_type').change(function(){
                var selected_type = $(this).val();
                $(this).parent().find('#options_scope option').each(function(){
                    var current_text = $(this).text();
                    $(this).text(current_text.slice(0,-1) + selected_type.slice(-1));
                });
            });

            $(this).before(new_options_filter);
            show(new_options_filter);

        });

        var options_list = new_item.find('#options_list');
        var options_list_placeholder = new_item.find('#options_list_placeholder');
        new_item.find('#apply_filtered_options').click(function(){
            hide(options_list);
            show(options_list_placeholder);
            new_item.find('[id^="options_filter"]').each(function(){
                var scope = $(this).find('#options_scope').val();
                options_list.append($('<li>' + scope + '</li>'));
            });
            options_list_placeholder.hide(3000, function(){
                show(options_list);
            });
        });

        $(this).before(new_item);
        show(new_item);
    });

});

</script>
</head>

<body>

    <header><h1>Fill your order</h1></header>

    <section id='order_details'>

        <h2>Details:</h2>

        <label>Title:</label>
        <select name='salutation' id='salutation'>
            <option value='Mr'>Mr</option>
            <option value='Mrs'>Mrs</option>
        </select>

        <label>First name:</label>
        <input type='text' name='first_name'/>

        <label>Last name:</label>
        <input type='text' name='last_name'/>

    </section>

    <section id='order_items'>

        <h2>Items:</h2>

        <article id='template_item' hidden>
            <div class='main_data'>
                <label>Name:</label>
                <input type='text' class='item_name'/>
                <label>Other data:</label>
                <input type='text' class='item_other_data'/>
            </div>

            <label>Advanced Options</label>
            <input type='checkbox' id='show_advanced_options'/>
            <section id='advanced_options' hidden>
                <ul id='options_list'>
                </ul>
                <p id='options_list_placeholder' hidden>Applying options...</p>
            </section>

            <label>Advanced Options Selector</label>
            <input type='checkbox' id='show_advanced_options_selector'/>
            <section id='advanced_options_selector' hidden>
                <article id='template_options_filter' hidden>
                    <label>Type:</label>
                    <select id='options_scope_type'>
                        <option value='type1'>type1</option>
                        <option value='type2'>type2</option>
                    </select>

                    <label>Options Scope:</label>
                    <select id='options_scope'>
                        <option>optionscope1fortype1</option>
                        <option>optionscope2fortype1</option>
                        <option>optionscope3fortype1</option>
                    </select>
                </article>
                <input type='submit' id='add_options_filter' value='Add Option Filter'/>
                <input type='submit' id='apply_filtered_options' value='Apply Filtered Options'/>

            </section>

        </article>

        <input type='submit' id='add_item' value='Add Item'/>

    </section>

</body>

</html>
